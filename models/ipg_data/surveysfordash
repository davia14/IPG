WITH addnames AS (SELECT surv.*, dim.name AS staff_name, dim.cluster FROM ip-ipg-data.ipg_transformations.surveysystemlvlpivoted LEFT OUTER JOIN ip-ipg-data.dimension_table.pmdim dim ON surv.new_system = dim.New_System),

emails AS (SELECT addnames.*, e.email_for_access, e.category FROM addnames LEFT OUTER JOIN ip-ipg-data.dimension_table.email_list AS e ON addnames.staff_name = e.staff_member_),

WITH surveysraw AS (
SELECT system_year_engagement_c, survey_collection_c, name, cfg_school_c, submitter_first_name_c, submitter_last_name_c, submitters_email_c, cfg_role_c, better_understanding_of_ipg_c, cfg_i_learned_something_c, cfg_valuable_use_of_my_time_c, clarity_direction_of_work_ahead_c, clear_about_change_we_seek_c, clear_about_roles_and_responsibilities_c, confidence_ability_support_instruction_c, confident_plan_will_achieve_goals_c, confident_plc_leads_to_learning_c, equipped_and_supported_c, feel_more_equipped_c, logistics_were_smooth_c, meeting_helped_make_decisions_c, objectives_were_met_c, plan_effectively_implemented_c, practice_will_improve_based_on_coaching_c, understand_state_of_instruction_c, cfg_1_2_impactful_moments_c, cfg_what_could_have_been_better_c
FROM ip-ipg-data.salesforce.survey_c), 

rawpivot AS (SELECT * FROM surveysraw UNPIVOT(response FOR question IN (better_understanding_of_ipg_c, cfg_i_learned_something_c, cfg_valuable_use_of_my_time_c, clarity_direction_of_work_ahead_c, clear_about_change_we_seek_c, clear_about_roles_and_responsibilities_c, confidence_ability_support_instruction_c, confident_plan_will_achieve_goals_c, confident_plc_leads_to_learning_c, equipped_and_supported_c, feel_more_equipped_c, logistics_were_smooth_c, meeting_helped_make_decisions_c, objectives_were_met_c, plan_effectively_implemented_c, practice_will_improve_based_on_coaching_c, understand_state_of_instruction_c))),

sys AS (SELECT raw.*, left(sys.name, length(sys.name)-16) AS system, school_year_c AS school_year FROM rawpivot AS raw LEFT OUTER JOIN ip-ipg-data.salesforce.system_year_engagement_c AS sys ON raw.system_year_engagement_c = sys.id)
